--[[
    ExoUI Library: Core Framework Module
    
    This file defines the ExoUI library, including the main window scaffolding,
    theme management, and the ExoUI:CreateTab method for dynamic feature tabs.
    
    The Init function creates the ScreenGui, MainWindow, TitleBar, and the
    empty TabContainer and ContentFrame.
    
    The ExoUI table is returned at the end, ready to be 'required' by a loader script.
]]

local ExoUI = {}

-- Define the key services and variables
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer and LocalPlayer:WaitForChild("PlayerGui")
local LibraryInstance = nil -- Main ScreenGui instance
local MainWindow = nil      -- Main Window Frame
local CurrentTheme = "Dark"

-- Color Palettes for themes
local Themes = {
    Dark = {
        PrimaryBg = Color3.fromRGB(32, 32, 32),
        SecondaryBg = Color3.fromRGB(40, 40, 40),
        AccentColor = Color3.fromRGB(150, 10, 255),
        TitleText = Color3.fromRGB(255, 255, 255),
        ContentText = Color3.fromRGB(200, 200, 200),
    },
    Light = {
        PrimaryBg = Color3.fromRGB(240, 240, 240),
        SecondaryBg = Color3.fromRGB(255, 255, 255),
        AccentColor = Color3.fromRGB(30, 144, 255),
        TitleText = Color3.fromRGB(0, 0, 0),
        ContentText = Color3.fromRGB(50, 50, 50),
    },
    BlueNight = {
        PrimaryBg = Color3.fromRGB(26, 43, 60),
        SecondaryBg = Color3.fromRGB(37, 58, 80),
        AccentColor = Color3.fromRGB(0, 191, 255),
        TitleText = Color3.fromRGB(230, 240, 255),
        ContentText = Color3.fromRGB(180, 200, 220),
    }
}

--***********************************************************************
--** Theme Management
--***********************************************************************

local function ApplyTheme(themeName)
    local theme = Themes[themeName]
    if not theme then return end

    if MainWindow then
        MainWindow.BackgroundColor3 = theme.PrimaryBg
        MainWindow:FindFirstChild("TitleBar").BackgroundColor3 = theme.SecondaryBg
        MainWindow:FindFirstChild("TitleBar"):FindFirstChild("TitleLabel").TextColor3 = theme.TitleText
        
        local TabContainer = MainWindow:FindFirstChild("TabContainer")
        if TabContainer then
            TabContainer.BackgroundColor3 = theme.SecondaryBg
            
            -- Update tab buttons and accent
            local ActiveTabValue = MainWindow.ActiveTab.Value
            for _, btn in TabContainer:FindFirstChild("Tabs"):GetChildren() do
                if btn:IsA("TextButton") then
                    btn.TextColor3 = theme.ContentText
                    if btn.Name == ActiveTabValue then
                        btn.UIStroke.Color = theme.AccentColor
                        btn.UIStroke.Thickness = 2
                    else
                        btn.UIStroke.Thickness = 0
                    end
                end
            end
        end
        
        local ContentFrame = MainWindow:FindFirstChild("ContentFrame")
        if ContentFrame then
            ContentFrame.BackgroundColor3 = theme.PrimaryBg
        end
        
        -- Update controls
        local SettingsButton = MainWindow:FindFirstChild("TitleBar"):FindFirstChild("SettingsButton")
        if SettingsButton then SettingsButton.ImageColor3 = theme.AccentColor end
        local Controls = MainWindow:FindFirstChild("TitleBar"):FindFirstChild("Controls")
        if Controls then
            Controls:FindFirstChild("CloseButton").TextColor3 = theme.ContentText
            Controls:FindFirstChild("MinimizeButton").TextColor3 = theme.ContentText
        end
    end
    CurrentTheme = themeName
end

local function CreateThemeOption(parent, themeName)
    local theme = Themes[themeName]
    local button = Instance.new("TextButton")
    button.Name = themeName .. "ThemeButton"
    button.Text = themeName
    button.Size = UDim2.new(1, 0, 0, 30)
    button.BackgroundColor3 = theme.PrimaryBg
    button.TextColor3 = theme.TitleText
    button.Font = Enum.Font.SourceSans
    button.TextSize = 14
    button.Parent = parent

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim2.new(0, 4)
    corner.Parent = button
    
    local stroke = Instance.new("UIStroke")
    stroke.Thickness = (themeName == CurrentTheme) and 2 or 1
    stroke.Color = theme.AccentColor
    stroke.Parent = button

    button.MouseEnter:Connect(function()
        stroke.Thickness = 2
    end)
    button.MouseLeave:Connect(function()
        if CurrentTheme ~= themeName then
            stroke.Thickness = 1
        end
    end)
    
    button.MouseButton1Click:Connect(function()
        ApplyTheme(themeName)
    end)
end


--***********************************************************************
--** UI Utilities
--***********************************************************************

local function MakeDraggable(frame, titleBar)
    local dragging = false
    local dragStart = Vector2.new(0, 0)
    local frameStart = Vector2.new(0, 0)

    titleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            frameStart = frame.AbsolutePosition
            input:Capture()
        end
    end)

    titleBar.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - dragStart
            local newPos = frameStart + delta
            
            local screenX = PlayerGui.AbsoluteSize.X
            local screenY = PlayerGui.AbsoluteSize.Y
            
            local clampedX = math.clamp(newPos.X, 0, screenX - frame.AbsoluteSize.X)
            local clampedY = math.clamp(newPos.Y, 0, screenY - frame.AbsoluteSize.Y)

            frame.Position = UDim2.fromOffset(clampedX, clampedY)
        end
    end)
end

local function SetupKeybind()
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if input.KeyCode == Enum.KeyCode.RightShift and not gameProcessed then
            if MainWindow then
                MainWindow.Visible = not MainWindow.Visible
            end
        end
    end)
end

--***********************************************************************
--** Public Methods
--***********************************************************************

-- Public method for creating and registering new tabs
function ExoUI:CreateTab(tabName, isDefault)
    if not MainWindow or not MainWindow:FindFirstChild("TabContainer") then
        error("ExoUI:CreateTab called before Init() or MainWindow not found.")
        return nil
    end

    local TabsFrame = MainWindow:FindFirstChild("TabContainer"):FindFirstChild("Tabs")
    local ContentFrame = MainWindow:FindFirstChild("ContentFrame")
    local ActiveTab = MainWindow.ActiveTab
    
    local isFirstTab = ActiveTab.Value == ""
    local shouldBeVisible = isDefault or (isFirstTab and tabName ~= "Settings")
    
    if isFirstTab and tabName ~= "Settings" then
        ActiveTab.Value = tabName
    end
    
    -- 1. Create Tab Button
    local tabButton = Instance.new("TextButton")
    tabButton.Name = tabName
    tabButton.Text = tabName
    tabButton.Size = UDim2.new(1, 0, 0, 40)
    tabButton.BackgroundColor3 = Themes[CurrentTheme].SecondaryBg
    tabButton.TextColor3 = Themes[CurrentTheme].ContentText
    tabButton.Font = Enum.Font.SourceSansBold
    tabButton.TextSize = 16
    tabButton.Parent = TabsFrame
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim2.new(0, 4)
    corner.Parent = tabButton

    local stroke = Instance.new("UIStroke")
    stroke.Thickness = shouldBeVisible and 2 or 0
    stroke.Color = Themes[CurrentTheme].AccentColor
    stroke.Parent = tabButton

    local padding = Instance.new("UIPadding")
    padding.PaddingTop = UDim.new(0.05, 0)
    padding.PaddingBottom = UDim.new(0.05, 0)
    padding.Parent = tabButton
    
    -- Set LayoutOrder to ensure Settings is always last
    tabButton.LayoutOrder = (tabName == "Settings") and 999 or 0 

    -- 2. Create Content Frame
    local contentFrame = Instance.new("Frame")
    contentFrame.Name = tabName .. "Content"
    contentFrame.Size = UDim2.new(1, 0, 1, 0)
    contentFrame.BackgroundTransparency = 1
    contentFrame.Parent = ContentFrame
    contentFrame.Visible = shouldBeVisible
    
    -- 3. Connect Tab Button Logic
    tabButton.MouseButton1Click:Connect(function()
        -- Deactivate all tabs visually
        for _, btn in tabButton.Parent:GetChildren() do
            if btn:IsA("TextButton") then
                btn.UIStroke.Thickness = 0
            end
        end
        
        -- Activate current tab visually
        stroke.Thickness = 2
        stroke.Color = Themes[CurrentTheme].AccentColor
        
        -- Set active tab 
        ActiveTab.Value = tabName
        
        -- Hide settings panel
        MainWindow.SettingsOpen.Value = false
        
        -- Hide all content frames
        for _, frame in ContentFrame:GetChildren() do
            if frame:IsA("Frame") then
                frame.Visible = false
            end
        end
        
        -- Show the selected content frame
        contentFrame.Visible = true
    end)
    
    return contentFrame -- Return the content frame for customization
end


-- Initialization function (Creates ALL scaffolding: ScreenGui, Window, Tab/Content Containers)
function ExoUI:Init(title)
    if LibraryInstance then
        print("ExoUI: Library already initialized.")
        return
    end
    
    if not PlayerGui then
        print("ExoUI: PlayerGui not found. Cannot initialize.")
        return
    end
    
    -- 1. Create ScreenGui (Main Container)
    LibraryInstance = Instance.new("ScreenGui")
    LibraryInstance.Name = "ExoUILibrary"
    LibraryInstance.DisplayOrder = 999
    LibraryInstance.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    LibraryInstance.Parent = PlayerGui
    
    -- 2. Create Main Window Frame (Scaffolding)
    MainWindow = Instance.new("Frame")
    MainWindow.Name = "MainWindow"
    MainWindow.Size = UDim2.new(0, 500, 0, 350)
    MainWindow.Position = UDim2.new(0.5, -250, 0.5, -175)
    MainWindow.BackgroundColor3 = Themes[CurrentTheme].PrimaryBg
    MainWindow.Parent = LibraryInstance
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim2.new(0, 8)
    corner.Parent = MainWindow
    
    local padding = Instance.new("UIPadding")
    padding.PaddingTop = UDim.new(0, 30)
    padding.Parent = MainWindow
    
    -- Title Bar, Controls, etc. (Omitted for brevity, but included in the complete module)
    -- ... (TitleBar, TitleLabel, CloseButton, MinimizeButton, SettingsButton setup) ...
    
    -- 3. Title Bar (Draggable Area)
    local TitleBar = Instance.new("Frame")
    TitleBar.Name = "TitleBar"
    TitleBar.Size = UDim2.new(1, 0, 0, 30)
    TitleBar.Position = UDim2.new(0, 0, 0, 0)
    TitleBar.BackgroundColor3 = Themes[CurrentTheme].SecondaryBg
    TitleBar.Parent = MainWindow
    MakeDraggable(MainWindow, TitleBar)

    local TitleLabel = Instance.new("TextLabel")
    TitleLabel.Name = "TitleLabel"
    TitleLabel.Text = title or "ExoUI Library"
    TitleLabel.Size = UDim2.new(1, -120, 1, 0)
    TitleLabel.Position = UDim2.new(0, 40, 0, 0)
    TitleLabel.BackgroundTransparency = 1
    TitleLabel.TextColor3 = Themes[CurrentTheme].TitleText
    TitleLabel.Font = Enum.Font.SourceSansBold
    TitleLabel.TextSize = 18
    TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
    TitleLabel.Parent = TitleBar
    
    -- 4. Controls (X and -)
    local Controls = Instance.new("Frame")
    Controls.Name = "Controls"
    Controls.Size = UDim2.new(0, 80, 1, 0)
    Controls.Position = UDim2.new(1, -80, 0, 0)
    Controls.BackgroundTransparency = 1
    Controls.Parent = TitleBar
    
    local ControlsList = Instance.new("UIListLayout")
    ControlsList.Padding = UDim.new(0, 5)
    ControlsList.FillDirection = Enum.FillDirection.Horizontal
    ControlsList.VerticalAlignment = Enum.VerticalAlignment.Center
    ControlsList.HorizontalAlignment = Enum.HorizontalAlignment.Right
    ControlsList.Parent = Controls
    
    -- Close (X) button
    local CloseButton = Instance.new("TextButton")
    CloseButton.Name = "CloseButton"
    CloseButton.Text = "X"
    CloseButton.Size = UDim2.new(0, 20, 0, 20)
    CloseButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    CloseButton.TextColor3 = Themes[CurrentTheme].ContentText
    CloseButton.Font = Enum.Font.SourceSansBold
    CloseButton.TextSize = 15
    CloseButton.Parent = Controls
    
    local CloseCorner = Instance.new("UICorner")
    CloseCorner.CornerRadius = UDim2.new(0.5, 0)
    CloseCorner.Parent = CloseButton
    
    CloseButton.MouseButton1Click:Connect(function()
        LibraryInstance:Destroy()
    end)
    
    -- Minimize (-) button
    local MinimizeButton = Instance.new("TextButton")
    MinimizeButton.Name = "MinimizeButton"
    MinimizeButton.Text = "-"
    MinimizeButton.Size = UDim2.new(0, 20, 0, 20)
    MinimizeButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    MinimizeButton.TextColor3 = Themes[CurrentTheme].ContentText
    MinimizeButton.Font = Enum.Font.SourceSansBold
    MinimizeButton.TextSize = 15
    MinimizeButton.Parent = Controls
    
    local MinimizeCorner = Instance.new("UICorner")
    MinimizeCorner.CornerRadius = UDim2.new(0.5, 0)
    MinimizeCorner.Parent = MinimizeButton
    
    MinimizeButton.MouseButton1Click:Connect(function()
        MainWindow.Visible = false
    end)
    
    -- 5. Settings Panel Button (Gear Icon)
    local SettingsButton = Instance.new("ImageButton")
    SettingsButton.Name = "SettingsButton"
    SettingsButton.Size = UDim2.new(0, 24, 0, 24)
    SettingsButton.Position = UDim2.new(0, 5, 0.5, -12)
    SettingsButton.BackgroundTransparency = 1
    SettingsButton.Image = "rbxassetid://15222045618" -- Example gear icon
    SettingsButton.ImageColor3 = Themes[CurrentTheme].AccentColor
    SettingsButton.Parent = TitleBar
    
    local SettingsOpen = Instance.new("BoolValue")
    SettingsOpen.Name = "SettingsOpen"
    SettingsOpen.Value = false
    SettingsOpen.Parent = MainWindow
    
    -- 6. Tab Container (Holds tabs and settings panel)
    local TabContainer = Instance.new("Frame")
    TabContainer.Name = "TabContainer"
    TabContainer.Size = UDim2.new(0.3, 0, 1, -30)
    TabContainer.Position = UDim2.new(0, 0, 0, 30)
    TabContainer.BackgroundColor3 = Themes[CurrentTheme].SecondaryBg
    TabContainer.Parent = MainWindow
    
    local TabList = Instance.new("UIListLayout")
    TabList.Padding = UDim.new(0, 5)
    TabList.SortOrder = Enum.SortOrder.LayoutOrder
    TabList.Parent = TabContainer
    
    local TabPadding = Instance.new("UIPadding")
    TabPadding.PaddingLeft = UDim.new(0, 5)
    TabPadding.PaddingRight = UDim.new(0, 5)
    TabPadding.PaddingTop = UDim.new(0, 5)
    TabPadding.PaddingBottom = UDim.new(0, 5)
    TabPadding.Parent = TabContainer

    -- Settings Sub-Panel (Handles Theme Options)
    local SettingsPanel = Instance.new("Frame")
    SettingsPanel.Name = "SettingsPanel"
    SettingsPanel.Size = UDim2.new(1, 0, 1, 0)
    SettingsPanel.BackgroundTransparency = 1
    SettingsPanel.Parent = TabContainer
    SettingsPanel.Visible = false

    local SettingsLayout = Instance.new("UIListLayout")
    SettingsLayout.Padding = UDim.new(0, 5)
    SettingsLayout.Parent = SettingsPanel
    
    local Label = Instance.new("TextLabel")
    Label.Text = "THEMES"
    Label.Size = UDim2.new(1, 0, 0, 20)
    Label.BackgroundTransparency = 1
    Label.TextColor3 = Themes[CurrentTheme].AccentColor
    Label.Font = Enum.Font.SourceSansBold
    Label.TextSize = 16
    Label.Parent = SettingsPanel
    
    -- Create theme options UI elements
    CreateThemeOption(SettingsPanel, "Dark")
    CreateThemeOption(SettingsPanel, "Light")
    CreateThemeOption(SettingsPanel, "BlueNight")

    -- Tabs Sub-Panel (Container for dynamically created tabs)
    local TabsFrame = Instance.new("Frame")
    TabsFrame.Name = "Tabs"
    TabsFrame.Size = UDim2.new(1, 0, 1, 0)
    TabsFrame.BackgroundTransparency = 1
    TabsFrame.Parent = TabContainer

    local TabsLayout = Instance.new("UIListLayout")
    TabsLayout.Padding = UDim.new(0, 5)
    TabsLayout.SortOrder = Enum.SortOrder.LayoutOrder
    TabsLayout.Parent = TabsFrame
    
    -- 7. Content Frame (The area where tab contents go)
    local ContentFrame = Instance.new("Frame")
    ContentFrame.Name = "ContentFrame"
    ContentFrame.Size = UDim2.new(0.7, 0, 1, -30)
    ContentFrame.Position = UDim2.new(0.3, 0, 0, 30)
    ContentFrame.BackgroundColor3 = Themes[CurrentTheme].PrimaryBg
    ContentFrame.Parent = MainWindow
    
    -- Value to track active tab (Crucial for cross-module communication)
    local ActiveTab = Instance.new("StringValue")
    ActiveTab.Name = "ActiveTab"
    ActiveTab.Value = "" 
    ActiveTab.Parent = MainWindow
    
    -- 8. Connect Settings Button
    SettingsButton.MouseButton1Click:Connect(function()
        SettingsOpen.Value = not SettingsOpen.Value
    end)
    
    SettingsOpen.Changed:Connect(function(value)
        if value then
            TabsFrame.Visible = false
            SettingsPanel.Visible = true
            -- Hide all feature content when settings open
            for _, frame in ContentFrame:GetChildren() do
                if frame:IsA("Frame") then frame.Visible = false end
            end
        else
            SettingsPanel.Visible = false
            TabsFrame.Visible = true
            -- Show active tab content when settings close
            local activeTabName = ActiveTab.Value
            if activeTabName ~= "" then
                local content = ContentFrame:FindFirstChild(activeTabName .. "Content")
                if content then content.Visible = true end
            end
        end
    end)
    
    -- 9. Setup Keybind
    SetupKeybind()
    
    -- Apply the initial theme (Dark) to finalize colors
    ApplyTheme(CurrentTheme)

    return ExoUI
end

return ExoUI
